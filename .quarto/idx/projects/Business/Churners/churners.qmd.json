{"title":"Customer Churn Prediction","markdown":{"yaml":{"title":"Customer Churn Prediction","author":"Orozco Karol M.","image":"churn.jpg","date":"3-11-2023","format":{"html":{"toc":true,"toc-location":"right","html-math-method":"katex","page-layout":"full"}},"execute":{"warning":false,"message":false},"categories":["R","Machine Learning","Prediction"]},"headingText":"Introduction:","containsRefs":false,"markdown":"\n\n\nThis report presents an analysis of bank customer churn using a dataset containing various attributes of bank customers. The goal is to predict whether a customer is likely to churn or not. The dataset consists of 10,127 rows and 20 columns, including both numeric and character variables. The objective is to create a model that predicts customer churn using only five features.\n\n## Approach and Methodology\n\nThe methodology employed in predicting bank churners consisted of several steps. Initially, the necessary R packages were loaded, including tidyverse, caret, pROC, MLmetrics, fastDummies, and skimr, to facilitate the analysis. The bank dataset, obtained from an external source, was imported and assigned to the \"bank\" variable.\n\nAn Exploratory Data Analysis (EDA) was conducted using the skim function, which provided summary statistics and distributions of the data. Visualizations, including histograms and scatter plots, were created to explore the relationships between variables and the churn outcome.\n\nPrincipal Component Analysis (PCA) was employed using the prcomp function after preprocessing the data through scaling and centering. The summary function offered insights into the results of PCA, and the screeplot visually displayed the variance explained by each principal component. The top five principal components were extracted, and their loadings were examined.\n\nTo determine variable importance, a Random Forest model was trained on the entire dataset using the train function from the caret package. The varImp function was used to calculate the importance of variables, and a plot was generated to visualize their significance.\n\nThe top two principal components, \"young_spenders\" and \"old_spenders,\" were selected, along with the top five variables from the dataset. These features were combined to create a new dataset called \"banksy.\"\n\nA K-Nearest Neighbors (KNN) model was trained on the banksy dataset using the train function, with the tuning parameter \"k\" determined through cross-validation. The model's performance was evaluated using a confusion matrix and the receiver operating characteristic (ROC) curve.\n\nTo address the class imbalance between churn and non-churn instances, downsampling was performed on the training dataset. The downSample function from the caret package was utilized for this purpose.\n\nAnother Random Forest model was then trained on the downsampled training dataset, and its performance was evaluated using a confusion matrix and the ROC curve.\n\nTwo gradient boosted models were trained: one using the original dataset with PCA variables, and the other using only the top five variables. Confusion matrices and ROC curves were utilized to evaluate the performance of both models.\n\nFinally, the best-performing model, fit_gbm2, was selected based on evaluation metrics and its optimal hyperparameters were printed.\n\nIn conclusion, the methodology involved various stages, including data preprocessing, exploratory analysis, dimensionality reduction using PCA, variable importance analysis with Random Forest, training and evaluating models such as KNN, Random Forest, and Gradient Boosted models, and ultimately selecting the best-performing model based on evaluation metrics.\n\n#### Load the required packages\n\n```{r}\nlibrary(tidyverse)\nlibrary(caret)\nlibrary(pROC)\nlibrary(MLmetrics)\nlibrary(fastDummies)\nlibrary(skimr)\n```\n\n## Data Summary:\n\nThe dataset contains six character variables and 14 numeric variables. The character variables include gender, education level, marital status, income category, card category, and churn (the target variable). The numeric variables include customer age, dependent count, months on book, total relationship count, months inactive in the last 12 months, contacts count in the last 12 months, credit limit, total revolving balance, average open-to-buy, total amount change from Q4 to Q1, total transaction amount, total transaction count, total count change from Q4 to Q1, and average utilization ratio.\n\n## Data Exploration:\n\nThe numeric variables have been analyzed using summary statistics. The mean age of bank customers is 46.33 years, with a standard deviation of 8.02. The age ranges from 26 to 73 years. The dependent count ranges from 0 to 5, with an average of 2.35. The months on book range from 13 to 56, with an average of 35.93. The total relationship count ranges from 1 to 6, with an average of 3.81. The months inactive in the last 12 months range from 0 to 6, with an average of 2.34. The contacts count in the last 12 months ranges from 0 to 6, with an average of 2.46. The credit limit ranges from 1,438.3 to 34,516, with an average of 8,631.95. The total revolving balance ranges from 0 to 2,517, with an average of 1,162.81. The average open-to-buy ranges from 3 to 34,516, with an average of 7,469.14. The total amount change from Q4 to Q1 ranges from 0 to 3.4, with an average of 0.76. The total transaction amount ranges from 510 to 18,484, with an average of 4,404.09. The total transaction count ranges from 10 to 139, with an average of 64.86. The total count change from Q4 to Q1 ranges from 0 to 3.71, with an average of 0.71. The average utilization ratio ranges from 0 to 1, with an average of 0.27.\n\n```{r}\nbank <-readRDS(gzcon(url(\"https://github.com/karolo89/Raw_Data/raw/main/BankChurners.rds\")))  \nbank = bank %>% rename_all(funs(tolower(.))) \n\nskim(bank)\n\nbank = bank %>% mutate(churn = as.factor(churn))\n\nvariables = bank %>% select(-churn) %>% colnames() \n\n```\n\n## Principal Component Analysis (PCA):\n\nPrincipal Component Analysis (PCA) was performed on the dataset to identify the most influential components. The scree plot revealed that the first \\[number\\] principal components explain a significant portion of the variance in the data. Based on the component loadings, the \"young spenders\" and \"old spenders\" components appear to be the most predictive of churn.\n\n```{r}\nbank = bank %>% mutate(churn = as.factor(churn))\nbank2 = bank %>% select(-churn) %>% dummy_cols(remove_selected_columns = T)\n\nbank3 = cbind(bank2, select(bank,churn))\n\npr_bank = prcomp(x = select(bank3,-churn), scale = T, center = T)\nsummary(pr_bank)\n\nscreeplot(pr_bank, type = \"lines\")\n\nhead(pr_bank$rotation)\n```\n\n```{r}\nrownames_to_column(as.data.frame(pr_bank$rotation)) %>% \n  select(1:5) %>% \n    filter(abs(PC1) >= 0.3 | abs(PC2) >= 0.3 | abs(PC3) >= 0.3 | abs(PC4) >= 0.3)\n\nprc = bind_cols(select(bank3, churn), as.data.frame(pr_bank$x)) %>%\n  select(1:5) %>%\n    rename(\"rich_men\" = PC1, \"cheap_men\" = PC2, \"young_spenders\" = PC3, \"old_spenders\"= PC4)\n\n#based on the graph below, \"young spenders\" and \"old spenders\" seem to be the most predictive of whether the customer will churn. \n\n# Pivot the data to long format\ndf_long <- prc %>%\n  pivot_longer(cols = -churn, names_to = \"component\", values_to = \"loading\")\n\n# Convert churn to a factor variable\ndf_long$churn <- as.factor(df_long$churn)\n\n# Define custom colors\ncustom_colors <- c(\"#E69F00\", \"#56B4E9\") # Replace with your preferred colors\n\n# Plot the density distribution with improved theme\nggplot(df_long, aes(loading, fill = churn)) +\n  geom_density(alpha = 0.5) +\n  facet_grid(. ~ component) +\n  theme_minimal() +  # Set the overall theme to minimal\n  labs(title = \"Density Distribution of Loading\",\n       x = \"Loading\", y = \"Density\") +  # Modify axis labels and title\n  scale_fill_manual(values = custom_colors) +  # Use custom colors\n  theme(plot.title = element_text(size = 16, face = \"bold\"),  # Adjust title appearance\n        axis.text = element_text(size = 12),  # Adjust axis text size\n        legend.title = element_blank(),  # Hide legend title\n        legend.position = \"bottom\")  # Position legend at the bottom\n\n\n```\n\n## Random Forest Model\n\n```{r}\nctrl <- trainControl(method = \"cv\", number = 3, classProbs=TRUE, summaryFunction = twoClassSummary)\n\nbank_index <- createDataPartition(bank$churn, p = 0.80, list = FALSE)\ntrain <- bank[ bank_index, ]\ntest <- bank[-bank_index, ]\n\nbig_model =train(churn ~ .,\n             data = train, \n             method = \"rf\",\n             tunelength = 4,\n             metric = \"ROC\",\n             trControl = ctrl)\n\n# Compute variable importance\nimportance <- varImp(big_model)\n\n# Plot variable importance with customized theme\nggplot(importance, aes(x = reorder(Variables, Importance), y = Importance)) +\n  geom_bar(stat = \"identity\", fill = \"#1f77b4\") +\n  labs(x = \"Variables\", y = \"Importance\") +\n  ggtitle(\"Variable Importance\") +\n  theme_minimal()\n\n#most important variables are total_trans_ct, total_trans_amt, total_revolving_bal, total_ct_chng_q4_41, total_relationship_count \n```\n\n## Combining PRC variables with top columns\n\n```{r}\n#choosing \"old_spenders\" and \"young_spenders\" to be 2 of the 5 total features in the model: \nprc2 = prc%>% select(young_spenders,old_spenders) \n\n#combining these features with rest of bank ds, then grabbing best variables: \nbanksy = cbind(prc2, bank3) %>% \n            select(young_spenders, old_spenders,total_trans_ct,total_trans_amt,total_revolving_bal, churn)\n```\n\n## KNN Model\n\n```{r}\n# specify the model to be used (i.e. KNN, Naive Bayes, decision tree, random forest, bagged trees) and the tuning parameters used\n\n\n\nset.seed(504) \n\nbank_index <- createDataPartition(banksy$churn, p = 0.80, list = FALSE)\ntrain <- banksy[ bank_index, ]\ntest <- banksy[-bank_index, ]\n\n# example spec for rf\nfit <- train(churn ~ .,\n             data = train, \n             method = \"knn\",\n             preProcess = c(\"center\",\"scale\"),\n             tuneGrid = expand.grid(k = seq(31,41,2)), # best K between 31 and 41 \n             metric = \"ROC\",\n             trControl = ctrl)\n\nfit\n\nconfusionMatrix(predict(fit, test),factor(test$churn))\n\nmyRoc <- roc(test$churn, predict(fit, test, type=\"prob\")[,2])\n\nplot(myRoc)\nauc(myRoc)\n#.95 AUC \n```\n\n## Downsampling bank data to remove imbalance of yes/no churn:\n\n```{r}\ntraindown = downSample(x = train[,-6], y= train$churn) %>% mutate(churn = Class) %>% select(-Class)\ntraindown %>% group_by(churn) %>% count()\n```\n\n## Random Forest Model with downsampling\n\n```{r}\nfit <- train(churn ~ .,\n             data = traindown, \n             method = \"rf\",\n             tuneLength = 4, \n             metric = \"ROC\",\n             trControl = ctrl)\n\nconfusionMatrix(predict(fit, test),factor(test$churn))\n\nmyRoc <- roc(test$churn, predict(fit, test, type=\"prob\")[,2])\n\nplot(myRoc)\nauc(myRoc) \n# AUC .97\n```\n\n## Gradient boosted model with PCA vs only top 5 variables:\n\n```{r}\n#with PCAs \"young spenders\" and \"old spenders\" \n\nfit_gbm1 <- train(churn ~ .,\n             data = train, \n             method = \"gbm\",\n             tuneLength = 4, \n             preProcess = c(\"center\",\"scale\"),\n             metric = \"ROC\",\n             trControl = ctrl)\n\n\nconfusionMatrix(predict(fit_gbm1, test),factor(test$churn))\n\nmyRoc <- roc(test$churn, predict(fit_gbm1, test, type=\"prob\")[,2])\n\nplot(myRoc)\n## auc(myRoc)\n#kappa = .76, AUC  = .97\n\n\n#with only top 5 variables \n\nbanksy2 = bank %>% select(total_amt_chng_q4_q1, total_trans_ct, total_trans_amt,total_revolving_bal, total_relationship_count,churn)\n\nbank_index2 <- createDataPartition(banksy2$churn, p = 0.80, list = FALSE)\ntrain2 <- banksy2[ bank_index2, ]\ntest2 <- banksy2[-bank_index2, ]\n\nfit_gbm2 <- train(churn ~ .,\n             data = train2, \n             method = \"gbm\",\n             tuneLength = 4, \n             preProcess = c(\"center\",\"scale\"),\n             metric = \"ROC\",\n             trControl = ctrl)\n\nconfusionMatrix(predict(fit_gbm2, test2),factor(test2$churn))\n\nmyRoc <- roc(test2$churn, predict(fit_gbm2, test2, type=\"prob\")[,2])\n\nplot(myRoc)\n## auc(myRoc)\n#kappa = .85, AUC .99\n```\n\n**Surprisingly, model with 5 non-PCA features performed better than the addition of 2 PCA features.**\n\n```{r}\n# Here are a few lines to inspect your best model. Add some comments about optimal hyperparameters.\nprint(fit_gbm2)\nprint(fit_gbm2$bestTune)\n```\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"message":false,"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"html-math-method":"katex","output-file":"churners.html"},"language":{"code-summary":"Behind the Scenes"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.313","editor":"visual","citations-hover":true,"footnotes-hover":true,"theme":{"light":"../../../LightTheme.css","dark":"DarkTheme.scss"},"code-copy":true,"title-block-banner":true,"title":"Customer Churn Prediction","author":"Orozco Karol M.","image":"churn.jpg","date":"3-11-2023","categories":["R","Machine Learning","Prediction"],"toc-location":"right","page-layout":"full"},"extensions":{"book":{"multiFile":true}}}}}